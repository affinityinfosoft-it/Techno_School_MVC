@{
    ViewBag.Title = "StudentIdCard";
    Layout = "~/Views/Shared/_SchoolLayout.cshtml";
}

<section class="content">
    <div class="container-fluid">

        <!-- Vertical Layout | With Floating Label -->
        <div class="row clearfix">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="header">
                        <h2>
                            Genarate  Student ID card
                            <small></small>
                        </h2>
                    </div>
                    <div class="body">
                        <form>
                            <div class="row">
                                <!-- Class Multi-select -->
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                    <div class="demo-masked-input">
                                        <div class="input-group">
                                            <div class="form-line">
                                                <label>Class :</label>
                                                @Html.ListBox("CLASSID", null, new
                    {
                        @class = "form-control show-tick",
                        multiple = "multiple",
                        required = "required",
                        onchange = "AjaxPostForDropDownSection()",
                        data_actions_box = "true"
                    })
                                                @Html.Hidden("SchoolId")
                                                @Html.Hidden("SessionId")
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section Multi-select -->
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                    <div class="demo-masked-input">
                                        <div class="input-group">
                                            <div class="form-line">
                                                <label>Section :</label>
                                                <select id="ddlSectionId" class="form-control show-tick" name="ddlSectionId"
                                                        multiple="multiple" data-actions-box="true"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Student ID -->
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                    <div class="demo-masked-input">
                                        <div class="input-group">
                                            <div class="form-line">
                                                <label>Student ID :</label>
                                                @Html.TextBox("StudentId", null,
                        new { @class = "form-control", placeholder = "Enter Student ID", required = "required" })
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Card Type -->
                                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                    <div class="form-group">
                                        <label for="CardType">Card Type</label>
                                        <select id="CardType" name="cardType" class="form-control">
                                            <option value="0">-- Select Card Type --</option>
                                            <option value="1">Identity Card</option>
                                            <option value="2">Escort Card</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            @{ if ((bool)Session["CanView"] == true)
                             {
                                <button type="button" id="btnView" class="btn btn-danger m-t-15 waves-effect">View Report</button>
                             }
                            }
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Vertical Layout | With Floating Label -->
    </div>
</section>
<script>
    $(document).ready(function () {


    });


    $("#btnView").click(function () {
        ReportView();
    });
    function ReportView() {
        var SchoolId = parseInt($("#SchoolId").val());
        var SessionId = parseInt($("#SessionId").val());

        // collect Class IDs (multi)
        var ClassIds = $("#CLASSID").val() || [];
        var ClassIdList = (ClassIds.length > 0) ? ClassIds.join(",") : "";

        // collect StudentId (single)
        var StudentId = $("#StudentId").val() ? $("#StudentId").val().trim() : "";

        // ✅ Validation: if both StudentId and Class are empty
        if (StudentId === "" && ClassIds.length === 0) {
            alert("⚠️ Please enter Student ID or select at least one class.");
            return; // stop further execution
        }
        // collect Section IDs (multi)
        var SectionIds = $("#ddlSectionId").val() || [];
        var SectionIdList = (SectionIds.length > 0) ? SectionIds.join(",") : "";

       

        // collect CardType
        var CardType = $("#CardType").val() || 0;

        // final url with all parameters
        var url = rootDir + "Masters/GenerateIdCards"
            + "?schoolId=" + SchoolId
            + "&sessionId=" + SessionId
            + "&classId=" + encodeURIComponent(ClassIdList)
            + "&sectionId=" + encodeURIComponent(SectionIdList)
            + "&studentId=" + encodeURIComponent(StudentId)
            + "&cardType=" + encodeURIComponent(CardType); // <-- added

        // open popup
        var WindowDimensions = "toolbars=no,menubar=no,location=no,titlebar=no,scrollbars=yes,resizable=yes,status=yes";
        var PopUp = window.open(url, "IdCardWindow", WindowDimensions);
        if (PopUp.outerWidth < screen.availWidth || PopUp.outerHeight < screen.availHeight) {
            PopUp.moveTo(25, 50);
            PopUp.resizeTo(screen.availWidth - 10, screen.availHeight - 10);
        }
    }



    function BindDropDownListForSection(ddl, dataCollection, selectedClassIds) {
        $(ddl).empty();

        // Populate only sections for selected classes
        var filteredData = dataCollection.filter(function (item) {
            return selectedClassIds.includes(item.SECM_CM_CLASSID);
        });

        for (var i = 0; i < filteredData.length; i++) {
            var opt = new Option(filteredData[i].SECM_SECTIONNAME, filteredData[i].SECM_SECTIONID);
            $(opt).attr("data-class", filteredData[i].SECM_CM_CLASSID);
            $(ddl).append(opt);
        }
    }

    function AjaxPostForDropDownSection(callback) {
        var selectedClassIds = ($('#CLASSID').val() || []).map(Number);

        if (selectedClassIds.length === 0) {
            $('#ddlSectionId').empty().selectpicker('refresh');
            return;
        }

        var _data = JSON.stringify({ ClassIds: selectedClassIds });

        $.ajax({
            type: "POST",
            url: rootDir + "JQuery/GetSectionByClassA",
            data: _data,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                BindDropDownListForSection($('#ddlSectionId'), data, selectedClassIds);
                $("#ddlSectionId").selectpicker('refresh');
                if (callback) callback();
            }
        });
    }



</script>
